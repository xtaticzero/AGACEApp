if(typeof PKI==="undefined"||!PKI)PKI={};if(typeof PKI.SAT==="undefined"||!PKI.SAT)PKI.SAT={};PKI.SAT.FielUtil=new function(){this.validaFiel=function(e,t,n,r){if(!this.validaEntradasCertificado(n,r)){return}if(!this.validaEntradasFirma(e,t,"...",r)){return}var i=new FileReader;i.onload=function(n){var s=new Uint8Array(i.result);var o="";for(var u=0;u<s.byteLength;u++){o+=String.fromCharCode(s[u])}var a=rstrtohex(o);var f=KJUR.asn1.ASN1Util.getPEMStringFromHex(a,"CERTIFICATE");var l=new X509;l.readCertPEM(f);var c=l.subjectPublicKeyRSA.n;if(typeof c==="undefined"){r(27);return}var h=new FileReader;h.onload=function(e){var n=new Uint8Array(h.result);var i="";for(var s=0;s<n.byteLength;s++){i+=String.fromCharCode(n[s])}var o=rstrtohex(i);var u=KJUR.asn1.ASN1Util.getPEMStringFromHex(o,"ENCRYPTED PRIVATE KEY");try{var a=KEYUTIL.getKey(u,t,"PKCS8PRV");t=null;var f=a.n;if(!c.equals(f)){r(28);return}}catch(e){if(e.indexOf("malformed format: SEQUENCE(0).items != 2")!==-1){r(24);return}else if(e==="malformed plain PKCS8 private key(code:001)"){r(25);return}else{r(24);return}}r(0,l)};h.readAsArrayBuffer(e.files[0])};i.readAsArrayBuffer(n.files[0])};this.firmaCadena=function(e,t,n,r){if(!this.validaEntradasFirma(e,t,n,r)){return}var i=new FileReader;i.onload=function(e){var s=new Uint8Array(i.result);var o="";for(var u=0;u<s.byteLength;u++){o+=String.fromCharCode(s[u])}var a=rstrtohex(o);var f=KJUR.asn1.ASN1Util.getPEMStringFromHex(a,"ENCRYPTED PRIVATE KEY");var l="";try{var c=KEYUTIL.getKey(f,t,"PKCS8PRV");t=null;var h=c.signString(n,"sha1");l=hex2b64(h)}catch(e){if(e.indexOf("malformed format: SEQUENCE(0).items != 2")!==-1){r(24);return}else if(e==="malformed plain PKCS8 private key(code:001)"){r(25);return}else{r(24);return}}r(0,l)};i.readAsArrayBuffer(e.files[0])};this.validaEntradasCertificado=function(e,t){if(typeof t!=="function"){throw"Se requiere una función callback al invocar el método firmar()"}if(typeof e==="undefined"||e===null){t(15);return false}if(typeof e.files==="undefined"){t(16);return false}if(e.files.length===0){t(26);return false}return true};this.validaEntradasFirma=function(e,t,n,r){if(typeof r!=="function"){throw"Se requiere una función callback al invocar el método firmar()"}if(typeof e==="undefined"||e===null){r(11);return false}if(typeof e.files==="undefined"){r(12);return false}if(typeof t==="undefined"||t===null){r(13);return false}if(typeof n==="undefined"){r(14);return false}if(e.files.length===0){r(21);return false}if(t===""){r(22);return false}if(n===""){r(23);return false}return true};this.leeCertificado=function(e,t){if(!this.validaEntradasCertificado(e,t)){return}var n=new FileReader;n.onload=function(e){var r=new Uint8Array(n.result);var i="";for(var s=0;s<r.byteLength;s++){i+=String.fromCharCode(r[s])}var o=rstrtohex(i);var u=KJUR.asn1.ASN1Util.getPEMStringFromHex(o,"CERTIFICATE");var a=new X509;a.readCertPEM(u);var f=a.subjectPublicKeyRSA.n;if(typeof f==="undefined"){t(27);return}t(0,a)};n.readAsArrayBuffer(e.files[0])};this.obtenRfc=function(e){var t=e.getSubjectString();var n=t.match(/\/undefined=[A-Z,\u00D1,\u00F1,&]{3,4}[0-9]{2}[0-1][0-9][0-3][0-9][A-Z,0-9]?[A-Z,0-9]?[0-9,A-Z]?[\s]{0,1}\//);if(n.length===1){var r=n[0].match(/[A-Z,\u00D1,\u00F1,&]{3,4}[0-9]{2}[0-1][0-9][0-3][0-9][A-Z,0-9]?[A-Z,0-9]?[0-9,A-Z]?/);if(r.length>0){return r[0];}else{return "";}}else{return""}};this.obtenNumSerie=function(e){var t=e.getSerialNumberHex();var n=1;var r="";while(n<t.length){var i=t.charAt(n);r=r+i;n=n+2}return r};this.obtenDateInicial=function(e){var t=e.getNotBefore();var n=parseInt(t.substring(0,2))+2e3;var r=parseInt(t.substring(2,4))-1;var i=parseInt(t.substring(4,6));var s=new Date(n,r,i);return s};this.obtenDateFinal=function(e){var t=e.getNotAfter();var n=parseInt(t.substring(0,2))+2e3;var r=parseInt(t.substring(2,4))-1;var i=parseInt(t.substring(4,6));var s=new Date(n,r,i,23,59,59);return s};this.isVigente=function(e){var t=this.obtenDateInicial(e);var n=this.obtenDateFinal(e);var r=new Date;if(r>=t&&r<=n){return true}else{return false}};this.obtenMensajeError=function(e){var t;if(typeof e==="undefined"||e===null){return"Desconocido"}switch(e){case 11:t="No se ha pasado un valor para filePrivateKey para llave privada";break;case 12:t="No se ha pasado un input del tipo file para llave privada";break;case 13:t="No se ha pasado un valor para contraseña";break;case 14:t="No se ha pasado un valor para la cadena a firmar";break;case 15:t="No se ha pasado un valor para fileCertificado para Certificado";break;case 16:t="No se ha pasado un input del tipo file para Certificado";break;case 21:t="Selecione una llave privada";break;case 22:t="Escriba la contraseña";break;case 23:t="Introduza la información a firmar";break;case 24:t="La llave privada no es válida";break;case 25:t="La contraseña no es válida";break;case 26:t="Seleccione un certificado";break;case 27:t="El certificado no es válido";break;case 28:t="El certificado no corresponde con la llave privada";break;default:t="Ocurrió una condición no válida";break}if(document.characterSet.toUpperCase()==="ISO-8859-1"||document.characterSet.toUpperCase()==="WINDOWS-1252"){var n=decodeURIComponent(escape(t));return n}else{return t}}}